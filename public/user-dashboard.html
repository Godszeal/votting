<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - VoteSphere</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" type="image/svg+xml" href="images/logo.svg">
</head>
<body>
  <header>
    <div class="container nav-container">
      <a href="../index.html" class="logo">
        <img src="images/logo.svg" alt="VoteSphere Logo">
        <span class="logo-text">VoteSphere</span>
      </a>
      <nav class="nav-links">
        <button id="logout-btn" class="btn btn-danger">Logout</button>
        <button class="theme-toggle" id="theme-toggle">
          <span id="theme-icon">🌙</span>
        </button>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="text-center mb-6">
      <h1>Welcome to VoteSphere</h1>
      <p class="text-gray">Cast your vote in upcoming elections and view results in real-time</p>
    </div>
    
    <div id="elections-container" class="dashboard-grid">
      <!-- Elections will be loaded here -->
      <div class="card text-center" style="padding: 3rem; grid-column: 1 / -1;">
        <div style="font-size: 3rem; color: var(--gray); margin-bottom: 1rem;">🔄</div>
        <h2 style="margin-bottom: 1rem;">Loading Elections...</h2>
        <p style="color: var(--gray);">Please wait while we check for available elections</p>
      </div>
    </div>
  </main>

  <footer>
    <div class="container footer-content">
      <p>&copy; 2023 VoteSphere. All rights reserved.</p>
      <div>
        <a href="#" class="text-gray" style="margin-right: 1rem;">Privacy Policy</a>
        <a href="#" class="text-gray">Terms of Service</a>
      </div>
    </div>
  </footer>

  <div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

  <script>
    // Check if user is logged in
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('No token found, redirecting to login');
        window.location.href = '../login.html';
        return;
      }
      
      // Check if there's an election ID in the URL
      const urlParams = new URLSearchParams(window.location.search);
      const electionId = urlParams.get('election');
      
      if (electionId) {
        console.log('Election ID found in URL:', electionId);
        // Verify if user can vote in this election
        verifyElectionEligibility(electionId);
      } else {
        console.log('No election ID in URL, loading all eligible elections');
        // Load all eligible elections
        loadElections();
      }
      
      // Setup logout
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          console.log('Logging out user');
          localStorage.removeItem('token');
          localStorage.removeItem('role');
          localStorage.removeItem('faculty');
          localStorage.removeItem('department');
          window.location.href = '../index.html';
        });
      }
    });
    
    async function verifyElectionEligibility(electionId) {
      try {
        const token = localStorage.getItem('token');
        
        if (!token) {
          throw new Error('Authentication token missing. Please log in again.');
        }
        
        console.log('Verifying election eligibility for ID:', electionId);
        
        const res = await fetch(`/api/user/elections/${electionId}/eligibility`, {
          method: 'GET',
          headers: {
            'x-auth-token': token,
            'Content-Type': 'application/json'
          }
        });
        
        if (!res.ok) {
          // Handle 403 specifically
          if (res.status === 403) {
            console.error('403 Forbidden - Authentication token may be invalid');
            localStorage.removeItem('token');
            window.location.href = '../login.html';
            return;
          }
          
          const error = await res.json().catch(() => ({}));
          console.error('Failed to verify election eligibility:', error);
          throw new Error(error.message || `Failed to verify election eligibility (Status: ${res.status})`);
        }
        
        const data = await res.json();
        console.log('Election eligibility ', data);
        
        if (data.eligible) {
          // User is eligible, load the voting interface
          loadVotingInterface(electionId);
        } else {
          // User is not eligible, show error
          console.error('User not eligible for election:', data.reason);
          showNotification(`You are not eligible to vote in this election: ${data.reason}`, 'error');
          loadElections();
        }
      } catch (err) {
        console.error('Error verifying election eligibility:', err);
        showNotification(`Error: ${err.message}`, 'error');
        loadElections();
      }
    }
    
    async function loadVotingInterface(electionId) {
      try {
        const token = localStorage.getItem('token');
        
        if (!token) {
          throw new Error('Authentication token missing. Please log in again.');
        }
        
        console.log('Loading voting interface for election ID:', electionId);
        
        const res = await fetch(`/api/user/elections/${electionId}`, {
          method: 'GET',
          headers: {
            'x-auth-token': token,
            'Content-Type': 'application/json'
          }
        });
        
        if (!res.ok) {
          const error = await res.json().catch(() => ({}));
          console.error('Failed to load election:', error);
          throw new Error(error.message || `Failed to load election (Status: ${res.status})`);
        }
        
        const election = await res.json();
        console.log('Election data loaded:', election);
        
        const electionsContainer = document.getElementById('elections-container');
        electionsContainer.innerHTML = '';
        
        // Format restriction badges
        let restrictionBadges = '';
        if (election.facultyRestriction) {
          restrictionBadges += `
            <span class="election-restriction">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.25rem;">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
              ${election.facultyRestriction} Faculty
            </span>
          `;
        }
        
        if (election.departmentRestrictions && election.departmentRestrictions.length > 0) {
          restrictionBadges += `
            <span class="election-restriction" style="background-color: var(--secondary);">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.25rem;">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
              ${election.departmentRestrictions.join(', ')}
            </span>
          `;
        }
        
        if (!restrictionBadges) {
          restrictionBadges = `
            <span class="election-restriction" style="background-color: var(--success);">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.25rem;">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              All Students
            </span>
          `;
        }
        
        let candidatesHTML = '';
        election.candidates.forEach(candidate => {
          const percentage = calculatePercentage(election.candidates, candidate.votes);
          candidatesHTML += `
            <div class="candidate">
              <div class="candidate-name">${candidate.name}</div>
              <div class="candidate-votes">${candidate.votes} votes (${percentage}%)</div>
              <div class="progress-bar">
                <div class="progress" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        });
        
        const electionCard = document.createElement('div');
        electionCard.className = 'election-card card fade-in';
        
        electionCard.innerHTML = `
          <div class="election-header">
            <h2 class="election-title">${election.title}</h2>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              ${restrictionBadges}
            </div>
          </div>
          
          <p class="election-description">${election.description}</p>
          
          <div class="election-candidates">
            ${candidatesHTML}
          </div>
          
          <div class="vote-actions">
            ${election.candidates.map(c => `
              <button class="btn btn-primary vote-btn" 
                      data-election="${election._id}" 
                      data-candidate="${c.name}">
                Vote for ${c.name}
              </button>
            `).join('')}
          </div>
        `;
        
        electionsContainer.appendChild(electionCard);
        
        // Add vote event listeners
        document.querySelectorAll('.vote-btn').forEach(btn => {
          btn.addEventListener('click', handleVote);
        });
        
      } catch (err) {
        console.error('Error loading election:', err);
        showNotification(`Error: ${err.message}`, 'error');
        loadElections();
      }
    }
    
    async function loadElections() {
      try {
        const token = localStorage.getItem('token');
        const faculty = localStorage.getItem('faculty');
        const department = localStorage.getItem('department');
        
        if (!token) {
          throw new Error('Authentication token missing. Please log in again.');
        }
        
        console.log('Loading all eligible elections for user');
        
        const res = await fetch('/api/user/elections', {
          headers: {
            'x-auth-token': token,
            'Content-Type': 'application/json'
          }
        });
        
        if (!res.ok) {
          // Handle 403 specifically
          if (res.status === 403) {
            console.error('403 Forbidden - Authentication token may be invalid');
            localStorage.removeItem('token');
            window.location.href = '../login.html';
            return;
          }
          
          const error = await res.json().catch(() => ({}));
          console.error('Failed to load elections:', error);
          throw new Error(error.message || `Failed to load elections (Status: ${res.status})`);
        }
        
        const elections = await res.json();
        console.log('Eligible elections loaded:', elections);
        
        const electionsContainer = document.getElementById('elections-container');
        electionsContainer.innerHTML = '';
        
        if (elections.length === 0) {
          electionsContainer.innerHTML = `
            <div class="card text-center" style="padding: 3rem; grid-column: 1 / -1;">
              <div style="font-size: 3rem; color: var(--gray); margin-bottom: 1rem;">🗳️</div>
              <h2 style="margin-bottom: 1rem;">No Active Elections</h2>
              <p style="color: var(--gray); max-width: 500px; margin: 0 auto;">
                There are no active elections available for you at the moment. Check back later or contact your student union.
              </p>
            </div>
          `;
          return;
        }
        
        elections.forEach(election => {
          const electionCard = document.createElement('div');
          electionCard.className = 'election-card card fade-in';
          electionCard.style.animationDelay = `${Math.random() * 0.3}s`;
          
          // Format restriction badges
          let restrictionBadges = '';
          if (election.facultyRestriction) {
            restrictionBadges += `
              <span class="election-restriction">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.25rem;">
                  <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
                ${election.facultyRestriction} Faculty
              </span>
            `;
          }
          
          if (election.departmentRestrictions && election.departmentRestrictions.length > 0) {
            restrictionBadges += `
              <span class="election-restriction" style="background-color: var(--secondary);">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.25rem;">
                  <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                </svg>
                ${election.departmentRestrictions.join(', ')}
              </span>
            `;
          }
          
          if (!restrictionBadges) {
            restrictionBadges = `
              <span class="election-restriction" style="background-color: var(--success);">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.25rem;">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                All Students
              </span>
            `;
          }
          
          let candidatesHTML = '';
          election.candidates.forEach(candidate => {
            const percentage = calculatePercentage(election.candidates, candidate.votes);
            candidatesHTML += `
              <div class="candidate">
                <div class="candidate-name">${candidate.name}</div>
                <div class="candidate-votes">${candidate.votes} votes (${percentage}%)</div>
                <div class="progress-bar">
                  <div class="progress" style="width: ${percentage}%"></div>
                </div>
              </div>
            `;
          });
          
          electionCard.innerHTML = `
            <div class="election-header">
              <h2 class="election-title">${election.title}</h2>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                ${restrictionBadges}
              </div>
            </div>
            
            <p class="election-description">${election.description}</p>
            
            <div class="election-candidates">
              ${candidatesHTML}
            </div>
            
            <div class="vote-actions">
              ${election.candidates.map(c => `
                <button class="btn btn-primary vote-btn" 
                        data-election="${election._id}" 
                        data-candidate="${c.name}">
                  Vote for ${c.name}
                </button>
              `).join('')}
            </div>
          `;
          
          electionsContainer.appendChild(electionCard);
        });
        
        // Add vote event listeners
        document.querySelectorAll('.vote-btn').forEach(btn => {
          btn.addEventListener('click', handleVote);
        });
        
      } catch (err) {
        console.error('Error loading elections:', err);
        
        const electionsContainer = document.getElementById('elections-container');
        electionsContainer.innerHTML = `
          <div class="card text-center" style="padding: 3rem; grid-column: 1 / -1;">
            <div style="font-size: 3rem; color: var(--danger); margin-bottom: 1rem;">⚠️</div>
            <h2 style="margin-bottom: 1rem; color: var(--danger);">Error Loading Elections</h2>
            <p style="color: var(--gray); max-width: 500px; margin: 0 auto 1.5rem;">
              ${err.message}
            </p>
            <button class="btn btn-primary" onclick="location.reload()">Retry</button>
          </div>
        `;
      }
    }
    
    function calculatePercentage(candidates, votes) {
      const total = candidates.reduce((sum, c) => sum + c.votes, 0);
      return total > 0 ? ((votes / total) * 100).toFixed(1) : 0;
    }
    
    async function handleVote(e) {
      const electionId = e.target.dataset.election;
      const candidate = e.target.dataset.candidate;
      
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          throw new Error('Authentication token missing. Please log in again.');
        }
        
        console.log('Attempting to cast vote for election:', electionId, 'candidate:', candidate);
        
        const res = await fetch('/api/user/vote', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
          },
          body: JSON.stringify({ electionId, candidate })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          console.log('Vote recorded successfully:', data);
          
          // Show success message
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-success';
          alertDiv.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Vote recorded successfully!
          `;
          alertDiv.style.position = 'fixed';
          alertDiv.style.top = '20px';
          alertDiv.style.right = '20px';
          alertDiv.style.zIndex = '9999';
          alertDiv.style.maxWidth = '400px';
          alertDiv.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
          document.body.appendChild(alertDiv);
          
          alertDiv.style.display = 'flex';
          
          setTimeout(() => {
            alertDiv.style.display = 'none';
            document.body.removeChild(alertDiv);
            
            // Reload elections to show updated results
            loadElections();
          }, 3000);
        } else {
          let errorMessage = data.msg || 'Failed to record vote';
          if (data.error) {
            errorMessage += `: ${data.error}`;
          }
          
          console.error('Vote recording failed:', errorMessage);
          
          // Show error message
          const alertDiv = document.createElement('div');
          alertDiv.className = 'alert alert-danger';
          alertDiv.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            ${errorMessage}
          `;
          alertDiv.style.position = 'fixed';
          alertDiv.style.top = '20px';
          alertDiv.style.right = '20px';
          alertDiv.style.zIndex = '9999';
          alertDiv.style.maxWidth = '400px';
          alertDiv.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
          document.body.appendChild(alertDiv);
          
          alertDiv.style.display = 'flex';
          
          setTimeout(() => {
            alertDiv.style.display = 'none';
            document.body.removeChild(alertDiv);
          }, 5000);
        }
      } catch (err) {
        console.error('Vote error:', err);
        
        // Show error message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger';
        alertDiv.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          Server error. Please try again.
        `;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.maxWidth = '400px';
        alertDiv.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
        document.body.appendChild(alertDiv);
        
        alertDiv.style.display = 'flex';
        
        setTimeout(() => {
          alertDiv.style.display = 'none';
          document.body.removeChild(alertDiv);
        }, 5000);
      }
    }
    
    function showNotification(message, type = 'info', duration = 5000) {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type}`;
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.zIndex = '9999';
      notification.style.maxWidth = '400px';
      notification.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
      
      let icon = '';
      switch(type) {
        case 'success':
          icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
          break;
        case 'error':
        case 'danger':
          icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
          break;
        case 'warning':
          icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
          break;
        default:
          icon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
      }
      
      notification.innerHTML = `${icon} ${message}`;
      
      const container = document.getElementById('notification-container');
      container.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
          container.removeChild(notification);
        }, 500);
      }, duration);
    }
    
    // Theme toggle functionality
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    
    // Check for saved theme preference or prefer-color-scheme
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
      document.documentElement.setAttribute('data-theme', 'dark');
      themeIcon.textContent = '☀️';
    }
    
    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      themeIcon.textContent = newTheme === 'dark' ? '☀️' : '🌙';
    });
  </script>
</body>
</html>
